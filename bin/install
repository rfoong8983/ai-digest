#!/usr/bin/env ruby
# frozen_string_literal: true

# Generates and installs the launchd plist with paths derived from the current environment.
#
# Usage:
#   ruby bin/install              # defaults to 10:00 AM
#   ruby bin/install 8:30         # set to 8:30 AM
#   ruby bin/install 14:00        # set to 2:00 PM

require "fileutils"

LABEL = "com.ai-digest"

# Parse time argument
hour, minute = 10, 0
if ARGV[0]
  parts = ARGV[0].split(":")
  hour = Integer(parts[0])
  minute = Integer(parts[1] || 0)
  unless (0..23).include?(hour) && (0..59).include?(minute)
    abort "Invalid time: #{ARGV[0]} (expected HH:MM in 24-hour format)"
  end
end

project_dir = File.expand_path("..", __dir__)
home_dir    = ENV.fetch("HOME")
wrapper     = File.join(project_dir, "bin", "run-digest.sh")
plist_dest  = File.join(home_dir, "Library", "LaunchAgents", "#{LABEL}.plist")

# Detect ruby version manager shims
rbenv_shims = "/opt/homebrew/opt/rbenv/shims"
mise_shims  = File.join(home_dir, ".mise", "shims")

shim_path = if Dir.exist?(rbenv_shims) && system("which rbenv > /dev/null 2>&1")
              rbenv_shims
            elsif Dir.exist?(mise_shims)
              mise_shims
            else
              nil
            end

path_components = [shim_path, "/opt/homebrew/bin", "/usr/local/bin", "/usr/bin", "/bin"].compact
path_value = path_components.join(":")

plist_content = <<~PLIST
  <?xml version="1.0" encoding="UTF-8"?>
  <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
  <plist version="1.0">
  <dict>
      <key>Label</key>
      <string>#{LABEL}</string>
      <key>ProgramArguments</key>
      <array>
          <string>/bin/bash</string>
          <string>#{wrapper}</string>
      </array>
      <key>StartCalendarInterval</key>
      <dict>
          <key>Hour</key>
          <integer>#{hour}</integer>
          <key>Minute</key>
          <integer>#{minute}</integer>
      </dict>
      <key>StandardOutPath</key>
      <string>/dev/null</string>
      <key>StandardErrorPath</key>
      <string>/dev/null</string>
      <key>WorkingDirectory</key>
      <string>#{project_dir}</string>
      <key>EnvironmentVariables</key>
      <dict>
          <key>PATH</key>
          <string>#{path_value}</string>
          <key>HOME</key>
          <string>#{home_dir}</string>
      </dict>
  </dict>
  </plist>
PLIST

# Unload existing job if loaded
system("launchctl", "unload", plist_dest, err: "/dev/null", out: "/dev/null") if File.exist?(plist_dest)

# Write plist
File.write(plist_dest, plist_content)
puts "Wrote #{plist_dest}"

# Also write a copy in the project for reference
File.write(File.join(project_dir, "#{LABEL}.plist"), plist_content)
puts "Updated #{LABEL}.plist in project directory"

# Load the job
system("launchctl", "load", plist_dest)
puts "Loaded #{LABEL}"

puts
formatted_time = format("%d:%02d %s", hour > 12 ? hour - 12 : (hour == 0 ? 12 : hour), minute, hour >= 12 ? "PM" : "AM")
puts "Schedule: daily at #{formatted_time}"
puts "Verify:   launchctl list | grep ai-digest"
puts "Logs:     tail -f #{project_dir}/digest.log"
